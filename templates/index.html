<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensible Input Generator</title>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <section>
      <div id='original-sentence' style="text-align:center; display: none;">
        <div>
					<p>
						<span id='original-sentence-text'>
						</span>
						<span id='original-sentence-score'>
						</span>
					</p>
        <br />
        </div>

        <div>
          <form id="inputForm">
              <label for="inputBox"></label>
              <input type="text" id="user-translation" name="user-translation" placeholder="Enter English translation here..." required />
          </form>
          <div style="text-align:center" id="check-translation">
            <button class="friendly-button-small" onclick="sendTranslationToServer()">Check</button>
            <button class="friendly-button-small" onclick="updatePageAfterTranslationCorrect()">Force Skip</button>
          </div>
        </div>
      </div>
      <br />

      <div style="text-align:center" id="generate-buttons">
        <button class="friendly-button" id="generate-button" onclick="generateButtonOnClick()">Generate New Sentence</button>
        <button class="friendly-button" id="extend-button" onclick="extendButtonOnClick()" style="display: none;">Extend Sentence</button>
      </div>
      <div class="center" id="loading-div">Generating (takes 10-15 secs)<span id="ellipsis">.</span></div>
      <div class="center" id="loading-div-2">Scoring (takes 10-15 secs)<span id="ellipsis-2">.</span></div>
    </section>

    <script>
      let ellipsisInterval;

      function startEllipsisAnimation(id) {
        const ellipsisElement = document.getElementById(id);
        let dotCount = 1;
        ellipsisInterval = setInterval(() => {
            dotCount = (dotCount + 1) % 4;
            ellipsisElement.innerHTML = '.'.repeat(dotCount);
        }, 500);
      }

      function stopEllipsisAnimation(id) {
        clearInterval(ellipsisInterval);
        document.getElementById(id).innerHTML = '...';
      }

      function generateButtonOnClick() {
        document.getElementById('loading-div').style.display = 'block';
        startEllipsisAnimation('ellipsis');
        sendSentenceToServer(false);
      }

      function extendButtonOnClick() {
        startEllipsisAnimation();
        sendSentenceToServer(true);
      }

      // When the user clicks on the button...
      function sendSentenceToServer(extend) {
        let route = "";

        if (extend) {
          route = "/extend_sentence";
        } else {
          route = "/generate_sentence";
        }

        fetch(route, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              original_sentence: document.getElementById('original-sentence-text').textContent
            })
        })
        .then(response => response.json())
        .then(data => {
            stopEllipsisAnimation('ellipsis');
            document.getElementById('loading-div').style.display = 'none';

            console.log('Success:', data);
            document.getElementById('generate-buttons').style.display = 'none';
            document.getElementById('original-sentence-text').innerHTML = data['sentence'];

						// Uncomment this line if you want the score to be visible next to the sentence
            document.getElementById('original-sentence-score').innerHTML = "(Score = " + data['score'] + ")";
            document.getElementById('original-sentence').style.display = 'block';
        })
				.catch(error => {
            stopEllipsisAnimation('ellipsis');
            document.getElementById('loading-div').style.display = 'none';
						console.error('Error:', error);
				});
      };

      function updatePageAfterTranslationCorrect() {
          alert("Translation is correct");
          document.getElementById('generate-buttons').style.display = 'block';
          // check if the extend button is visible
          if (document.getElementById('extend-button').style.display === 'none') {
              document.getElementById('extend-button').style.display = 'inline';
          }
          // clear the input
          document.getElementById('user-translation').value = '';
      }

      function sendTranslationToServer() {
          startEllipsisAnimation('ellipsis-2');
          document.getElementById('loading-div-2').style.display = 'block';

          console.log('Sending translation to server');
          let user_translation = document.getElementById('user-translation').value;
          let original_sentence = document.getElementById('original-sentence-text');
          console.log(original_sentence);
          original_sentence = original_sentence.textContent;
          console.log(original_sentence);
          if (original_sentence === null || original_sentence === undefined || original_sentence === "") {
            console.log("Original sentence is empty");
            return;
          }
          original_sentence = original_sentence.trim().replace(/\s+/g, ' ');;
          console.log("Original sentence: " + original_sentence);
          const responseMessage = document.getElementById('responseMessage');

          console.log('Sending translation to server');
          fetch('/evaluate_translation', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ 
                original_sentence: original_sentence,
                user_translation: user_translation
              })
          })
          .then(response => response.json())
          .then(data => {
              stopEllipsisAnimation('ellipsis-2');
              document.getElementById('loading-div-2').style.display = 'none';

              console.log('Success evaluating translation:', data);
              // Case data into int
              num = parseInt(data['is_correct']);
              console.log("num=" + num);
              if ((num == 0) && (user_translation != "")) {
                // Bold the occurrances of data['wrong_words'] 
                let wrong_words = data['wrong_words'];
                // Iterate through each wrong word and bold it
                wrong_words.forEach(function(word) {
                  let original_sentence = document.getElementById('original-sentence-text').innerHTML;
                  let bolded_word = "<b>" + word + "</b>";
                  // Only match when there a word boundary
                  let re = new RegExp("\\b" + word + "\\b", "g");
                  original_sentence = original_sentence.replace(re, bolded_word);

                  document.getElementById('original-sentence-text').innerHTML = original_sentence;
                });

                console.log('Wrong words: ' + wrong_words);
                let original_sentence = document.getElementById('original-sentence-text').innerHTML;
                console.log('Original sentence: ' + original_sentence);
              }

              // Make sure the user didn't enter a blank "" response
              if ((num == 1) && (user_translation != "")) {
                  updatePageAfterTranslationCorrect();
              } else {
                  alert("Translation is incorrect");
              }
          })
          .catch(error => {
              stopEllipsisAnimation('ellipsis-2');
              document.getElementById('loading-div-2').style.display= 'none';
              console.error('Error:', error);
          });
      };
    </script>
</body>
</html>

