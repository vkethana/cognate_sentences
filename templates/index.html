<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>French Story Translation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        #story-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sentence-block {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .sentence-block.active {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sentence-block.correct {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .sentence-block.incorrect {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
        }

        .french-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .flag {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .translation-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 5px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            padding: 10px 20px;
            font-size: 1.1em;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .next-button {
            font-size: 1.5em;
            padding: 10px 20px;
        }

        /* Debug button styling - Remove in production */
        .debug-button {
            background-color: #6c757d;
            margin-left: 5px;
        }
        
        .debug-button:hover {
            background-color: #5a6268;
        }

        .difficulty {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
        }

        .completed-translation {
            margin-top: 10px;
            color: #28a745;
            font-style: italic;
        }

        #settings-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .start-prompt {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div id="settings-panel">
        <button onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </div>

    <div id="story-container">
        <div id="sentence-display">
            <div class="start-prompt">
                <button onclick="handleNext()" class="next-button" title="Next sentence">‚û°Ô∏è</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);">
        <div class="modal" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h2>Settings</h2>
            <p>Enter your OpenAI API key to enable translation verification:</p>
            <input type="password" id="api-key-input" style="width: 100%; padding: 8px; margin: 10px 0;" placeholder="sk-..."/>
            <button onclick="saveApiKey()">Save</button>
        </div>
    </div>

    <script>
        // Initialize local storage
        if (!localStorage.getItem('currentStoryFile')) {
            localStorage.setItem('currentStoryFile', '');
            localStorage.setItem('currentSentenceIndex', '0');
            localStorage.setItem('userDifficulty', '2.5');
            localStorage.setItem('seenStories', JSON.stringify([]));
        }

        let currentSentenceToTranslate = '';
        
        function createSentenceBlock(sentence, difficulty, isActive = false) {
            const block = document.createElement('div');
            block.className = `sentence-block ${isActive ? 'active' : ''}`;
            
            const frenchContainer = document.createElement('div');
            frenchContainer.className = 'french-container';
            frenchContainer.innerHTML = `
                <span class="flag">üá´üá∑</span>
                <span class="sentence">${sentence}</span>
                <span class="difficulty">üìä ${parseFloat(difficulty).toFixed(2)}</span>
            `;
            block.appendChild(frenchContainer);

            if (isActive) {
                const translationContainer = document.createElement('div');
                translationContainer.className = 'translation-container';
                translationContainer.innerHTML = `
                    <span class="flag">üá¨üáß</span>
                    <input type="text" class="translation-input" placeholder="...">
                    <button onclick="checkTranslation(this)" title="Check translation">‚úì</button>
                    <!-- DEBUG BUTTON - Remove in production -->
                    <button onclick="forceSkip(this)" title="Force skip" class="debug-button">‚è≠Ô∏è</button>
                `;
                block.appendChild(translationContainer);

                const feedback = document.createElement('div');
                feedback.className = 'feedback';
                block.appendChild(feedback);
            }

            return block;
        }

        async function handleSpacePress() {
            const display = document.getElementById('sentence-display');
            
            // Clear start prompt if it exists
            const startPrompt = display.querySelector('.start-prompt');
            if (startPrompt) {
                display.innerHTML = '';
            }

            const currentStoryFile = localStorage.getItem('currentStoryFile');
            let currentSentenceIndex = parseInt(localStorage.getItem('currentSentenceIndex'));

            const response = await fetch('/get-sentence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    currentStoryFile === '' ?
                    { 
                        needNewStory: true,
                        userDifficulty: parseFloat(localStorage.getItem('userDifficulty')),
                        seenStories: JSON.parse(localStorage.getItem('seenStories'))
                    } :
                    { 
                        storyFile: currentStoryFile,
                        sentenceIndex: currentSentenceIndex
                    }
                )
            });

            const data = await response.json();
            
            if (data.isLastSentence) {
                const seenStories = JSON.parse(localStorage.getItem('seenStories'));
                seenStories.push(currentStoryFile);
                localStorage.setItem('seenStories', JSON.stringify(seenStories));
                localStorage.setItem('currentStoryFile', '');
                localStorage.setItem('currentSentenceIndex', '0');
                display.innerHTML = '<div class="start-prompt">üèÅ <button onclick="handleNext()" class="next-button" title="Next story">‚û°Ô∏è</button></div>';
                return;
            }

            // Create and append new sentence block
            const sentenceBlock = createSentenceBlock(data.sentence, data.sentenceDifficulty, true);
            display.appendChild(sentenceBlock);
            currentSentenceToTranslate = data.sentence;

            // Update storage
            if (data.storyFile) {
                localStorage.setItem('currentStoryFile', data.storyFile);
                localStorage.setItem('currentSentenceIndex', '1');
            } else {
                localStorage.setItem('currentSentenceIndex', (currentSentenceIndex + 1).toString());
            }

            // Scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        async function checkTranslation(button) {
            const block = button.closest('.sentence-block');
            const input = block.querySelector('.translation-input');
            const feedback = block.querySelector('.feedback');
            const apiKey = localStorage.getItem('openai_api_key');

            if (!apiKey) {
                alert('Please set your OpenAI API key in settings first.');
                return;
            }

            const translation = input.value.trim();
            if (!translation) {
                alert('Please enter a translation');
                return;
            }

            try {
                const response = await fetch('/score_translation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        original: currentSentenceToTranslate,
                        translation: translation
                    })
                });

                const data = await response.json();
                
                if (data.isCorrect) {
                    // Add success styling
                    block.classList.remove('active', 'incorrect');
                    block.classList.add('correct');
                    
                    // Add the completed translation to the block
                    const completedTranslation = document.createElement('div');
                    completedTranslation.className = 'completed-translation';
                    completedTranslation.textContent = translation;
                    block.appendChild(completedTranslation);

                    // Remove the translation input container
                    block.querySelector('.translation-container').remove();
                    
                    // Trigger next sentence
                    handleSpacePress();
                } else {
                    // Add error styling
                    block.classList.remove('correct');
                    block.classList.add('incorrect');
                    
                    // Bold incorrect morphemes in the original sentence
                    if (data.wrongMorphemes && data.wrongMorphemes.length > 0) {
                        const frenchSentence = block.querySelector('.sentence');
                        let sentenceHtml = currentSentenceToTranslate;
                        data.wrongMorphemes.forEach(morpheme => {
                            sentenceHtml = sentenceHtml.replace(
                                morpheme,
                                `<strong style="color: #dc3545">${morpheme}</strong>`
                            );
                        });
                        frenchSentence.innerHTML = sentenceHtml;
                    }
                    
                    // Reset to active state after a short delay
                    setTimeout(() => {
                        block.classList.remove('incorrect');
                        block.classList.add('active');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error checking translation:', error);
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Error checking translation. Please try again.';
                feedback.style.display = 'block';
            }
        }

        function openSettings() {
            document.getElementById('settings-modal').style.display = 'block';
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                document.getElementById('settings-modal').style.display = 'none';
            } else {
                alert('Please enter a valid API key');
            }
        }

        // Event Listeners
        async function handleNext() {
            const activeBlock = document.querySelector('.sentence-block.active');
            if (!activeBlock) {
                await handleSpacePress();
            }
        }

        async function forceSkip(button) {
            const block = button.closest('.sentence-block');
            
            // Remove the translation container
            block.querySelector('.translation-container').remove();
            
            // Remove the active class
            block.classList.remove('active');
            
            // Trigger next sentence
            await handleSpacePress();
        }

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.classList.contains('translation-input')) {
                const button = e.target.nextElementSibling;
                if (button) {
                    button.click();
                }
            }
        });

        // Close modal when clicking outside
        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    </script>
</body>
</html>
