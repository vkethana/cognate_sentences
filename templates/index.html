<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Reader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        #stats-panel {
            position: fixed;  /* Fixed to window corner */
            top: 10px;
            right: 10px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 14px;
            min-width: 200px;
            z-index: 100;  /* Above story container but below modals */
        }

        #story-container {
            width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;  /* For positioning the settings link */
        }

        #settings-link {
            position: absolute;
            top: -30px;  /* Position above the container */
            right: 0;
            font-size: 16px;
        }

        #sentence-display {
            font-size: 20px;
            padding: 30px;
            text-align: left;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        #sentence-display p {
            margin: 0 0 15px 0;
            line-height: 1.5;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            z-index: 1001;
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }

        .modal p {
            margin-bottom: 20px;
            line-height: 1.5;
            color: #666;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .modal button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .modal button:hover {
            background-color: #0056b3;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="stats-panel">
        <p>Your Level: <span class="stat-value" id="user-difficulty">1.5</span></p>
        <p>Story Level: <span class="stat-value" id="story-difficulty">-</span></p>
        <p>Stories Seen: <span class="stat-value" id="stories-seen-count">0</span></p>
    </div>
    <div id="story-container">
        <a href="#" id="settings-link">settings</a>
        <div id="sentence-display">
            press spacebar to begin
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <h2>Settings</h2>
            <div class="warning">
                ⚠️ Important: For your security, please remember to deactivate this API key after you're done using the application. 
                We will only use your API key to verify translations and promise not to use it for any other purpose.
            </div>
            <p>Please enter your OpenAI API key to enable translation verification:</p>
            <input type="password" id="api-key-input" placeholder="sk-..." />
            <button onclick="saveApiKey()">Save API Key</button>
        </div>
    </div>

    <!-- Translation Exercise Modal -->
    <div class="modal-overlay" id="translation-modal">
        <div class="modal">
            <h2>Translation Exercise</h2>
            <div id="no-api-key-message" style="display: none;">
                <p>Please set your OpenAI API key in settings first to continue with translation exercises.</p>
                <button onclick="openSettings()">Go to Settings</button>
            </div>
            <div id="translation-exercise" style="display: none;">
                <p>Please translate this sentence to English:</p>
                <div class="french-sentence"></div>
                <textarea id="translation-input" rows="3" style="width: 100%; margin: 10px 0; padding: 8px;"></textarea>
                <div class="error-message" style="color: #dc3545; margin-bottom: 10px; display: none;"></div>
                <button onclick="checkTranslation()">Check Translation</button>
                <button onclick="skipTranslation()">Skip Translation</button>
                <div class="attempts-remaining" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize client-side storage and state
        localStorage.setItem('currentStoryFile', '');
        localStorage.setItem('currentSentenceIndex', '0');
        if (!localStorage.getItem('userDifficulty')) {
            localStorage.setItem('userDifficulty', '1.5'); // Start at middle difficulty
        }
        if (!localStorage.getItem('seenStories')) {
            localStorage.setItem('seenStories', JSON.stringify([]));
        }

        // Update initial stats display
        document.getElementById('user-difficulty').textContent = 
            parseFloat(localStorage.getItem('userDifficulty')).toFixed(2);
        document.getElementById('stories-seen-count').textContent = 
            JSON.parse(localStorage.getItem('seenStories')).length;

        let translationExercisePending = false;
        let currentTranslationAttempts = 0;
        const MAX_TRANSLATION_ATTEMPTS = 3;
        const TRANSLATION_FREQUENCY = 3; // Show translation exercise every n sentences
        
        // Difficulty adjustment parameters
        const DIFFICULTY_STEP = 0.1;  // How much to adjust difficulty after each story
        const MAX_DIFFICULTY = 3.0;
        const MIN_DIFFICULTY = 0.0;

        // Settings modal functionality
        const settingsModal = document.getElementById('settings-modal');
        const settingsLink = document.getElementById('settings-link');
        const apiKeyInput = document.getElementById('api-key-input');

        settingsLink.addEventListener('click', function(e) {
            e.preventDefault();
            settingsModal.style.display = 'block';
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        });

        settingsModal.addEventListener('click', function(e) {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                settingsModal.style.display = 'none';
            } else {
                alert('Please enter a valid API key');
            }
        }

        function openSettings() {
            document.getElementById('translation-modal').style.display = 'none';
            settingsModal.style.display = 'block';
        }

        const translationModal = document.getElementById('translation-modal');
        let currentSentenceToTranslate = '';

        function showTranslationExercise() {
            const apiKey = localStorage.getItem('openai_api_key');
            translationExercisePending = true;
            currentTranslationAttempts = 0;
            
            const noApiKeyMessage = document.getElementById('no-api-key-message');
            const translationExercise = document.getElementById('translation-exercise');
            
            if (!apiKey) {
                noApiKeyMessage.style.display = 'block';
                translationExercise.style.display = 'none';
            } else {
                noApiKeyMessage.style.display = 'none';
                translationExercise.style.display = 'block';
                document.querySelector('.french-sentence').textContent = currentSentenceToTranslate;
                document.getElementById('translation-input').value = '';
                document.querySelector('.error-message').style.display = 'none';
                document.querySelector('.attempts-remaining').textContent = 
                    `Attempts remaining: ${MAX_TRANSLATION_ATTEMPTS}`;
            }
            
            translationModal.style.display = 'block';
        }

        async function skipTranslation() {
            // Increase difficulty slightly for correct translations
            let currentDifficulty = parseFloat(localStorage.getItem('userDifficulty'));
            currentDifficulty = Math.min(MAX_DIFFICULTY, currentDifficulty + DIFFICULTY_STEP);
            localStorage.setItem('userDifficulty', currentDifficulty.toString());
            document.getElementById('user-difficulty').textContent = currentDifficulty.toFixed(2);
                    
            translationExercisePending = false;
            translationModal.style.display = 'none';
        }

        async function checkTranslation() {
            const translationInput = document.getElementById('translation-input').value.trim();
            const apiKey = localStorage.getItem('openai_api_key');
            
            if (!translationInput) {
                document.querySelector('.error-message').textContent = 'Please enter a translation';
                document.querySelector('.error-message').style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/score_translation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        original: currentSentenceToTranslate,
                        translation: translationInput
                    })
                });

                const data = await response.json();
                
                if (data.isCorrect) {
                    // Increase difficulty slightly for correct translations
                    let currentDifficulty = parseFloat(localStorage.getItem('userDifficulty'));
                    currentDifficulty = Math.min(MAX_DIFFICULTY, currentDifficulty + DIFFICULTY_STEP);
                    localStorage.setItem('userDifficulty', currentDifficulty.toString());
                    document.getElementById('user-difficulty').textContent = currentDifficulty.toFixed(2);
                    
                    translationExercisePending = false;
                    translationModal.style.display = 'none';
                } else {
                    currentTranslationAttempts++;
                    if (currentTranslationAttempts >= MAX_TRANSLATION_ATTEMPTS) {
                        // Decrease difficulty for failed translations
                        let currentDifficulty = parseFloat(localStorage.getItem('userDifficulty'));
                        currentDifficulty = Math.max(MIN_DIFFICULTY, currentDifficulty - DIFFICULTY_STEP);
                        localStorage.setItem('userDifficulty', currentDifficulty.toString());
                        document.getElementById('user-difficulty').textContent = currentDifficulty.toFixed(2);
                        
                        translationExercisePending = false;
                        translationModal.style.display = 'none';
                    } else {
                        document.querySelector('.error-message').textContent = 
                            'Translation needs improvement. Please try again.';
                        document.querySelector('.error-message').style.display = 'block';
                        document.querySelector('.attempts-remaining').textContent = 
                            `Attempts remaining: ${MAX_TRANSLATION_ATTEMPTS - currentTranslationAttempts}`;
                    }
                }
            } catch (error) {
                console.error('Error checking translation:', error);
                document.querySelector('.error-message').textContent = 
                    'Error checking translation. Please try again.';
                document.querySelector('.error-message').style.display = 'block';
            }
        }

        translationModal.addEventListener('click', function(e) {
            if (e.target === translationModal) {
                translationModal.style.display = 'none';
            }
        });

        const contentDiv = document.getElementById('sentence-display');

        document.addEventListener('keydown', async function(event) {
            if (event.code === 'Space') {
                event.preventDefault();  // Prevent page scrolling
                const translationModalVisible = translationModal.style.display === 'block';
                const settingsModalVisible = settingsModal.style.display === 'block';
                
                // If any modal is visible, don't proceed with story
                if (translationModalVisible || settingsModalVisible) {
                    return;
                }
                
                await handleSpacePress();
            }
        });

        async function handleSpacePress() {
            // If there's a pending translation exercise, show the modal again
            if (translationExercisePending) {
                showTranslationExercise();
                return;
            }

            const currentStoryFile = localStorage.getItem('currentStoryFile');
            let currentSentenceIndex = parseInt(localStorage.getItem('currentSentenceIndex'));

            const response = await fetch('/get-sentence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(
                    currentStoryFile === '' ?
                    { 
                        needNewStory: true,
                        userDifficulty: parseFloat(localStorage.getItem('userDifficulty')),
                        seenStories: JSON.parse(localStorage.getItem('seenStories'))
                    } :
                    { 
                        storyFile: currentStoryFile,
                        sentenceIndex: currentSentenceIndex
                    }
                )
            });
            console.log("current sentence index is", currentSentenceIndex)

            const data = await response.json();
            currentSentenceToTranslate = data.sentence;

            if (data.isLastSentence) {
                // Update seen stories list
                const seenStories = JSON.parse(localStorage.getItem('seenStories'));
                seenStories.push(currentStoryFile);
                localStorage.setItem('seenStories', JSON.stringify(seenStories));
                document.getElementById('stories-seen-count').textContent = seenStories.length;
                
                // Log seen stories to console
                console.log('Stories seen so far:', seenStories);
                
                // Reset for next story
                localStorage.setItem('currentStoryFile', '');
                localStorage.setItem('currentSentenceIndex', '0');
                contentDiv.textContent = 'press spacebar to begin';
                document.getElementById('story-difficulty').textContent = '-';
                return;
            }

            // Handle sentence display
            if (currentSentenceIndex == 0) {
                // This is the first sentence of a new story
                console.log("First sentence")
                // Put it in <p> tags
                contentDiv.innerHTML = '<p>' + data.sentence + '</p>';
                // Update story difficulty display if provided
                if (data.storyDifficulty !== undefined) {
                    document.getElementById('story-difficulty').textContent = 
                        parseFloat(data.storyDifficulty).toFixed(2);
                }
            } else {
                // Append the new sentence to existing story
                // Show every sentence on a different line using distinct <p> tags
                contentDiv.innerHTML += '<p>' + data.sentence + '</p>';
                
                // Check if we need to show translation exercise
                if (currentSentenceIndex > 1 && (currentSentenceIndex - 1) % TRANSLATION_FREQUENCY === 0) {
                    showTranslationExercise();
                }
            }

            // Update client-side storage
            if (data.storyFile) {
                localStorage.setItem('currentStoryFile', data.storyFile);
                localStorage.setItem('currentSentenceIndex', '1');
            } else {
                localStorage.setItem('currentSentenceIndex', (currentSentenceIndex + 1).toString());
            }
        }
    </script>
</body>
</html>
